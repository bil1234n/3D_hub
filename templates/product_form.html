<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Product Entry</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        :root { --accent: #c5a059; --dark: #111; --light: #f8f9fa; }
        body { background: #f0f2f5; font-family: 'Inter', sans-serif; padding: 40px 0; }
        .glass-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: none; }
        .section-title { font-weight: 600; font-size: 1.1rem; margin: 25px 0 15px 0; color: var(--dark); border-bottom: 2px solid var(--light); padding-bottom: 5px; }
        
        /* Dropzone */
        .upload-zone {
            border: 2px dashed #ddd; border-radius: 16px; padding: 30px;
            text-align: center; cursor: pointer; transition: 0.3s; background: var(--light);
            margin-bottom: 10px;
        }
        .upload-zone:hover { border-color: var(--accent); background: #fffdf9; }
        
        /* Preview Grid */
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 15px; }
        .preview-item { 
            position: relative; height: 100px; border-radius: 12px; overflow: hidden; border: 1px solid #eee;
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn {
            position: absolute; top: 5px; right: 5px; background: rgba(255, 0, 0, 0.8);
            color: white; border: none; width: 22px; height: 22px; border-radius: 50%;
            cursor: pointer; font-size: 14px; line-height: 1;
        }
        
        .submit-btn {
            background: var(--dark); color: white; border: none; width: 100%;
            padding: 15px; border-radius: 12px; font-weight: 600; margin-top: 30px;
        }
    </style>
</head>
<body>

<div class="container" style="max-width: 800px;">
    <div class="glass-card">
        <h2 class="mb-4">Product Registration</h2>

        {% if form.errors %}
        <div class="alert alert-danger">
            <strong>Error:</strong> Please check the fields below.
            {{ form.errors }}
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="main-form">
            {% csrf_token %}

            <div class="section-title">General Details</div>
            <div class="row">
                <div class="col-md-6 mb-3"><label>Name</label>{{ form.name }}</div>
                <div class="col-md-6 mb-3"><label>Category</label>{{ form.category }}</div>
            </div>
            <div class="mb-3"><label>Price ($)</label>{{ form.price }}</div>
            <div class="mb-3"><label>Description</label>{{ form.description }}</div>

            <div class="section-title">Visuals</div>
            <label>Main Image</label>
            {{ form.main_image }}

            <label class="mt-3">Gallery Expansion</label>
            <div class="upload-zone" id="dropzone">
                <p class="m-0 text-muted">Click to add multiple gallery photos</p>
                <input type="file" id="temp-gallery-input" multiple accept="image/*" style="display:none">
            </div>
            <div id="preview-grid" class="preview-grid"></div>

            <div class="section-title">Technical</div>
            <label>3D Model (.glb)</label>
            {{ form.model_3d }}

            <button type="submit" class="submit-btn">PUBLISH PRODUCT</button>
        </form>
    </div>
</div>

<script>
    let galleryFiles = [];
    const dropzone = document.getElementById('dropzone');
    const tempInput = document.getElementById('temp-gallery-input');
    const previewGrid = document.getElementById('preview-grid');
    const form = document.getElementById('main-form');

    dropzone.onclick = () => tempInput.click();

    tempInput.addEventListener('change', function() {
        const files = Array.from(this.files);
        files.forEach(file => {
            if (galleryFiles.length < 9) galleryFiles.push(file);
        });
        render();
        this.value = ''; 
    });

    function render() {
        previewGrid.innerHTML = '';
        galleryFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${e.target.result}">
                    <button type="button" class="remove-btn" onclick="removeFile(${index})">Ã—</button>
                `;
                previewGrid.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeFile(index) {
        galleryFiles.splice(index, 1);
        render();
    }

    // THE FIX: Properly injecting files before submission
    form.addEventListener('submit', function(e) {
        const dataTransfer = new DataTransfer();
        galleryFiles.forEach(file => dataTransfer.items.add(file));
        
        // Create the REAL input that Django views look for
        const realInput = document.createElement('input');
        realInput.type = 'file';
        realInput.name = 'gallery_images'; // Matches request.FILES.getlist('gallery_images')
        realInput.multiple = true;
        realInput.files = dataTransfer.files;
        realInput.style.display = 'none';
        
        this.appendChild(realInput);
    });
</script>
</body>
</html>