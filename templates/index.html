<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luxé | Enterprise AR Engine</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #c5a059; --dark: #111; --glass: rgba(255, 255, 255, 0.9); --shadow: 0 20px 40px rgba(0,0,0,0.1); }
        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        body { margin: 0; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; background: #fff; color: var(--dark); }

        /* Layout Architecture */
        .sidebar { width: 340px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 100; transition: transform 0.5s ease; }
        .sidebar.hidden { transform: translateX(-100%); margin-right: -340px; }
        .sidebar-header { padding: 40px 30px; letter-spacing: 6px; font-weight: 200; font-size: 1.4rem; text-align: center; border-bottom: 1px solid #f9f9f9; }
        
        .product-list { flex: 1; overflow-y: auto; padding: 20px; }
        .item-card { 
            padding: 20px; margin-bottom: 15px; cursor: pointer; border-radius: 20px;
            background: #f8f8f8; border: 1px solid transparent;
        }
        .item-card.active { background: #fff; border-color: var(--accent); box-shadow: var(--shadow); }

        .view-selector {
            width: 100%; margin-top: 12px; padding: 10px; border-radius: 10px; border: 1px solid #ddd;
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
        }

        /* Stage Area */
        .main-stage { flex: 1; position: relative; background: radial-gradient(circle at center, #ffffff 0%, #f2f2f2 100%); }
        model-viewer { width: 100%; height: 100%; --poster-color: transparent; }

        /* UI Overlays */
        .control-dock { position: absolute; top: 30px; right: 30px; display: flex; gap: 15px; z-index: 100; }
        .icon-btn { 
            width: 50px; height: 50px; background: white; border: none; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow);
        }
        .icon-btn:hover { background: var(--dark); color: white; }

        .glass-panel { 
            position: absolute; bottom: 30px; left: 50%; transform: translate(-50%, 40px);
            width: 90%; max-width: 480px; background: var(--glass); backdrop-filter: blur(20px);
            padding: 35px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.5);
            box-shadow: var(--shadow); z-index: 20; opacity: 0; pointer-events: none;
        }
        .glass-panel.show { transform: translate(-50%, 0); opacity: 1; pointer-events: auto; }

        .ar-btn { 
            width: 100%; background: var(--dark); color: white; border: none; padding: 20px;
            border-radius: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Modal Logic */
        #qr-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .qr-card { background: white; padding: 40px; border-radius: 30px; text-align: center; width: 340px; }
        
        #image-overlay { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: #fff; z-index: 5; }
        #image-overlay img { max-width: 80%; max-height: 80%; object-fit: contain; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">LUXÉ</div>
    <div class="product-list" id="ui-list"></div>
</div>

<div class="main-stage">
    <div class="control-dock">
        <button class="icon-btn" id="toggleSide"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
        <button class="icon-btn" id="toggleInfo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></button>
    </div>

    <model-viewer id="viewer" 
        camera-controls auto-rotate shadow-intensity="2" 
        environment-image="neutral" exposure="1"
        ar ar-modes="webxr scene-viewer quick-look" 
        ar-scale="auto" loading="eager" crossorigin="anonymous">
        <button slot="ar-button" id="hidden-ar-button" style="display:none;"></button>
    </model-viewer>

    <div id="image-overlay"><img id="gallery-img" src=""></div>

    <div class="glass-panel" id="info-panel">
        <h2 id="p-title">Product</h2>
        <div id="p-price" style="font-size: 1.5rem; margin-bottom: 10px;">$0.00</div>
        <p id="p-desc" style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 25px;"></p>
        <button class="ar-btn" id="launch-ar">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M7 11V7c0-2.21 1.79-4 4-4h2c2.21 0 4 1.79 4 4v4h2V7c0-3.31-2.69-6-6-6h-2c-3.31 0-6 2.69-6 6v4h2z"/></svg>
            VIEW IN YOUR SPACE
        </button>
    </div>
</div>

<div id="qr-modal">
    <div class="qr-card">
        <h3>View in AR</h3>
        <p style="font-size: 0.85rem; color: #666;">Scan with your mobile device to place this item in your room.</p>
        <img id="qr-code" style="width: 200px; height: 200px; margin: 20px 0;">
        <button id="close-qr" style="width:100%; padding:15px; border:none; background:#eee; border-radius:10px; cursor:pointer;">Close</button>
    </div>
</div>

<script>
    const CLOUD_NAME = "duhidqjmj";
    
    // Crucial: Cloudinary delivery logic
    function getCloudinaryUrl(path, isModel = false) {
        if (!path) return "";
        if (path.startsWith('http')) return path.replace('http://', 'https://');
        const type = isModel ? 'raw/upload' : 'image/upload';
        const cleanPath = path.replace('/media/', '');
        return `https://res.cloudinary.com/${CLOUD_NAME}/${type}/${cleanPath}`;
    }

    const inventory = [
        {% for p in products %}
        {
            id: "{{ p.id|escapejs }}",
            name: "{{ p.name|escapejs }}",
            price: "{{ p.price|escapejs }}",
            desc: "{{ p.description|escapejs }}",
            category: "{{ p.category|escapejs }}",
            model: getCloudinaryUrl("{{ p.model_3d.url|escapejs }}", true),
            thumb: getCloudinaryUrl("{{ p.main_image.url|escapejs }}")
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    const viewer = document.getElementById('viewer');
    const infoPanel = document.getElementById('info-panel');
    const qrModal = document.getElementById('qr-modal');

    // AR Engine Logic
    function triggerAR() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Attempt 1: Direct activation via component
        if (viewer.canActivateAR) {
            viewer.activateAR();
        } 
        // Attempt 2: Intent-based trigger for Android/iOS if detection is sluggish
        else if (isMobile) {
            const arButton = document.getElementById('hidden-ar-button');
            arButton.click();
        } 
        // Attempt 3: Desktop Fallback
        else {
            const currentUrl = encodeURIComponent(window.location.href);
            document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${currentUrl}`;
            qrModal.style.display = 'flex';
        }
    }

    function selectProduct(id) {
        const item = inventory.find(p => p.id == id);
        if (!item) return;

        viewer.src = item.model;
        document.getElementById('p-title').innerText = item.name;
        document.getElementById('p-price').innerText = `$${item.price}`;
        document.getElementById('p-desc').innerText = item.desc;
        
        infoPanel.classList.add('show');
        document.querySelectorAll('.item-card').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-id="${id}"]`).classList.add('active');
    }

    // Initialize
    const listContainer = document.getElementById('ui-list');
    listContainer.innerHTML = inventory.map(p => `
        <div class="item-card" data-id="${p.id}" onclick="selectProduct('${p.id}')">
            <span style="font-size:10px; color:var(--accent); font-weight:600;">${p.category}</span>
            <div style="font-weight:600;">${p.name}</div>
        </div>
    `).join('');

    // Event Listeners
    document.getElementById('launch-ar').onclick = triggerAR;
    document.getElementById('close-qr').onclick = () => qrModal.style.display = 'none';
    document.getElementById('toggleSide').onclick = () => document.getElementById('sidebar').classList.toggle('hidden');
    document.getElementById('toggleInfo').onclick = () => infoPanel.classList.toggle('show');

    if (inventory.length > 0) selectProduct(inventory[0].id);
</script>

</body>
</html>
