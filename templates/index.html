<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luxé | Native AR Router</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #c5a059; --dark: #111; --bg: #f4f4f4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #fff; height: 100vh; display: flex; flex-direction: column; }

        /* Clean Header */
        header { padding: 20px; text-align: center; border-bottom: 1px solid #eee; background: #fff; z-index: 10; }
        header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 4px; font-weight: 300; }

        /* Web 3D Preview */
        .preview-container { flex: 1; position: relative; background: var(--bg); }
        model-viewer { width: 100%; height: 100%; outline: none; }

        /* Native AR Control Panel */
        .control-panel { 
            background: #fff; padding: 30px; border-top: 1px solid #eee; 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.03); z-index: 10;
        }
        
        .product-meta { margin-bottom: 20px; }
        .product-title { font-size: 1.5rem; font-weight: 600; margin: 0 0 5px 0; }
        .product-price { color: var(--accent); font-size: 1.1rem; font-weight: 600; margin: 0; }

        /* The Deep Link Button */
        .btn-native-ar {
            width: 100%; padding: 20px; border-radius: 12px; border: none;
            background: var(--dark); color: #fff; font-size: 1rem; font-weight: 600;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-native-ar:hover { background: #000; }

        /* Desktop Fallback */
        .desktop-warning {
            display: none; padding: 15px; background: #fff3cd; color: #856404;
            border-radius: 8px; margin-top: 15px; font-size: 0.9rem; text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <h1>LUXÉ</h1>
    </header>

    <div class="preview-container">
        <model-viewer id="web-preview" 
            camera-controls 
            auto-rotate 
            shadow-intensity="1"
            environment-image="neutral">
        </model-viewer>
    </div>

    <div class="control-panel">
        <div class="product-meta">
            <h2 class="product-title" id="p-title">Loading...</h2>
            <p class="product-price" id="p-price">$0.00</p>
        </div>
        
        <button class="btn-native-ar" id="btn-ar">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            OPEN NATIVE AR
        </button>
        
        <div class="desktop-warning" id="desktop-msg">
            AR is only available on iOS and Android devices.
        </div>
    </div>

<script>
    // 1. DATA (Simplified URL structure)
    // We are trusting the URL as-is, assuming Django gave us the raw Cloudinary link.
    const currentProduct = {
        name: "{{ products.0.name|escapejs }}",
        price: "{{ products.0.price|escapejs }}",
        // Crucial: The URL MUST be https:// and MUST point to the actual file.
        glbUrl: "{{ products.0.model_3d.url|escapejs }}".replace('http://', 'https://')
    };

    // Fallback for testing if Django tags are empty
    if (!currentProduct.glbUrl || currentProduct.glbUrl.includes('None')) {
        // This is a Google official test model. If this works, your Cloudinary URL is the issue.
        currentProduct.glbUrl = "https://modelviewer.dev/shared-assets/models/Astronaut.glb";
        currentProduct.name = "Test Astronaut (System Check)";
    }

    // 2. INITIALIZE WEB VIEWER
    document.getElementById('p-title').innerText = currentProduct.name;
    document.getElementById('p-price').innerText = `$${currentProduct.price}`;
    document.getElementById('web-preview').src = currentProduct.glbUrl;

    // 3. THE NATIVE INTENT ROUTER
    document.getElementById('btn-ar').addEventListener('click', () => {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const encodedUrl = encodeURIComponent(currentProduct.glbUrl);
        const title = encodeURIComponent(currentProduct.name);

        // --- ANDROID ROUTING (Google Scene Viewer) ---
        if (/android/i.test(userAgent)) {
            // This is a native deep link. It tells Android to open the Google AR app directly.
            // It bypasses the browser entirely, dodging CORS and MIME type issues.
            const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodedUrl}&title=${title}&mode=ar_only#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;S.browser_fallback_url=${encodedUrl};end;`;
            window.location.href = intentUrl;
            return;
        }

        // --- iOS ROUTING (Apple AR Quick Look) ---
        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            // iOS ideally needs a .usdz file. 
            // If you only have .glb, iOS 13+ MIGHT convert it, but it's not guaranteed.
            // This creates a hidden link with rel="ar" and clicks it, forcing iOS Quick Look.
            const anchor = document.createElement('a');
            anchor.setAttribute('rel', 'ar');
            // Note: If you have a USDZ field in Django, put that URL here instead.
            anchor.appendChild(document.createElement('img')); 
            anchor.setAttribute('href', currentProduct.glbUrl);
            anchor.click();
            return;
        }

        // --- DESKTOP FALLBACK ---
        document.getElementById('desktop-msg').style.display = 'block';
    });
</script>
</body>
</html>
