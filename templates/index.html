<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luxé | Enterprise AR Engine (Blob Proxy)</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #c5a059; --dark: #0f0f0f; --err: #ff4d4d; --glass: rgba(255, 255, 255, 0.98); }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #fff; height: 100vh; display: flex; overflow: hidden; }

        .sidebar { width: 320px; border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fff; z-index: 100; }
        .sidebar-header { padding: 40px 25px; border-bottom: 1px solid #f5f5f5; }
        .sidebar-header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 5px; font-weight: 300; }
        .product-list { flex: 1; overflow-y: auto; padding: 15px; }
        .product-item { padding: 20px; margin-bottom: 10px; border-radius: 15px; cursor: pointer; background: #fcfcfc; border: 1px solid #f0f0f0; transition: 0.3s; }
        .product-item.active { border-color: var(--accent); background: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

        .stage { flex: 1; position: relative; background: #f9f9f9; }
        model-viewer { width: 100%; height: 100%; background: #f9f9f9; --poster-color: transparent; }

        .ui-overlay { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 200; }
        .info-card { background: var(--glass); padding: 30px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        
        .ar-button { 
            width: 100%; padding: 20px; border: none; border-radius: 15px; 
            background: var(--dark); color: #fff; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px; transition: 0.2s;
        }
        .ar-button:disabled { background: #ccc; cursor: not-allowed; }

        #diagnostic-log {
            position: absolute; top: 20px; left: 20px; width: 300px; max-height: 200px; overflow-y: auto;
            background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace; 
            font-size: 11px; padding: 15px; border-radius: 10px; z-index: 500; pointer-events: none;
        }
        .log-error { color: var(--err); font-weight: bold; }
        .log-warn { color: #ffd700; }
    </style>
</head>
<body>

    <div id="diagnostic-log">SYSTEM IDLE...</div>

    <aside class="sidebar">
        <div class="sidebar-header"><h1>LUXÉ</h1></div>
        <div class="product-list" id="p-list"></div>
    </aside>

    <main class="stage">
        <model-viewer id="engine"
            camera-controls auto-rotate shadow-intensity="1"
            ar ar-modes="webxr scene-viewer quick-look"
            crossorigin="anonymous" loading="eager">
        </model-viewer>

        <div class="ui-overlay">
            <div class="info-card">
                <h2 id="view-name" style="margin:0 0 5px 0; font-weight: 400;">Loading...</h2>
                <div id="view-price" style="color: var(--accent); font-weight: 600; margin-bottom: 20px;">$0.00</div>
                <button class="ar-button" id="ar-trigger">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    <span id="btn-text">VIEW IN YOUR SPACE</span>
                </button>
            </div>
        </div>
    </main>

<script>
    const CLOUD_NAME = "duhidqjmj";
    
    // Cloudinary path cleaner
    function resolveAsset(url) {
        if (!url || url === "None") return "";
        let path = url.replace('/media/', '').split('?')[0]; // Strip URL params
        if (path.includes('res.cloudinary.com')) return path.replace('http://', 'https://');
        return `https://res.cloudinary.com/${CLOUD_NAME}/raw/upload/${path}`;
    }

    const inventory = [
        {% for p in products %}
        {
            id: "{{ p.id|escapejs }}",
            name: "{{ p.name|escapejs }}",
            price: "{{ p.price|escapejs }}",
            raw_url: resolveAsset("{% if p.model_3d %}{{ p.model_3d.url|escapejs }}{% endif %}")
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    const Engine = {
        viewer: document.getElementById('engine'),
        log: document.getElementById('diagnostic-log'),
        btn: document.getElementById('ar-trigger'),
        btnText: document.getElementById('btn-text'),
        currentBlobUrl: null,

        init() {
            this.updateLog("Initializing Pro AR Engine...");
            this.renderList();
            if (inventory.length > 0) this.select(inventory[0].id);
            
            this.btn.addEventListener('click', () => this.launchAR());
        },

        updateLog(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString().split(' ')[0];
            let classStr = '';
            if(type === 'error') classStr = 'log-error';
            if(type === 'warn') classStr = 'log-warn';
            
            const line = `<div class="${classStr}">[${timestamp}] ${msg}</div>`;
            this.log.innerHTML = line + this.log.innerHTML;
        },

        // --- THE PROFESSIONAL BLOB PROXY ---
        async fetchAndFixMimeType(url) {
            this.updateLog(`Downloading asset into memory...`, 'warn');
            this.btn.disabled = true;
            this.btnText.innerText = "PROCESSING 3D DATA...";

            try {
                // Fetch the bad file from Cloudinary
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const arrayBuffer = await response.arrayBuffer();
                
                // FORCE THE CORRECT MIME TYPE HERE
                const blob = new Blob([arrayBuffer], { type: 'model/gltf-binary' });
                
                // Clear out old memory to prevent browser crashes
                if (this.currentBlobUrl) URL.revokeObjectURL(this.currentBlobUrl);
                
                this.currentBlobUrl = URL.createObjectURL(blob);
                
                this.updateLog("MIME Type patched successfully. Blob generated.");
                return this.currentBlobUrl;

            } catch (err) {
                this.updateLog(`CORS/Fetch Error: ${err.message}`, 'error');
                // Fallback to raw URL if fetch fails due to Cloudinary CORS settings
                return url; 
            } finally {
                this.btn.disabled = false;
                this.btnText.innerText = "VIEW IN YOUR SPACE";
            }
        },

        async select(id) {
            const item = inventory.find(p => p.id == id);
            this.updateLog(`Selected: ${item.name}`);
            
            document.getElementById('view-name').innerText = item.name;
            document.getElementById('view-price').innerText = `$${item.price}`;
            document.querySelectorAll('.product-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-id="${id}"]`).classList.add('active');

            // Pass through the Proxy
            const safeUrl = await this.fetchAndFixMimeType(item.raw_url);
            this.viewer.src = safeUrl;
        },

        launchAR() {
            this.updateLog("Executing AR Handoff...");
            
            if (!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                this.updateLog("Desktop blocked.", 'error');
                alert("Please open this link on a mobile device to use Augmented Reality.");
                return;
            }

            if (this.viewer.canActivateAR) {
                this.updateLog("WebXR/ARCore Handshake Approved.");
                this.viewer.activateAR();
            } else {
                this.updateLog("Fallback AR required.", 'warn');
                alert("Ensure your phone's AR services are updated.");
            }
        },

        renderList() {
            const container = document.getElementById('p-list');
            container.innerHTML = inventory.map(p => `
                <div class="product-item" data-id="${p.id}" onclick="Engine.select('${p.id}')">
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="font-size:12px; color:#999;">$${p.price}</div>
                </div>
            `).join('');
        }
    };

    window.onload = () => Engine.init();
</script>
</body>
</html>
