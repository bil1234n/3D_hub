<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luxé | Enterprise AR Engine</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #c5a059; --dark: #0f0f0f; --err: #ff4d4d; --glass: rgba(255, 255, 255, 0.98); }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #fff; height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar Architecture */
        .sidebar { width: 320px; border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fff; z-index: 100; }
        .sidebar-header { padding: 40px 25px; border-bottom: 1px solid #f5f5f5; }
        .sidebar-header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 5px; font-weight: 300; }

        .product-list { flex: 1; overflow-y: auto; padding: 15px; }
        .product-item { 
            padding: 20px; margin-bottom: 10px; border-radius: 15px; cursor: pointer; 
            background: #fcfcfc; border: 1px solid #f0f0f0; transition: 0.3s;
        }
        .product-item.active { border-color: var(--accent); background: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

        /* Main Viewport */
        .stage { flex: 1; position: relative; background: #f9f9f9; }
        model-viewer { width: 100%; height: 100%; background: #f9f9f9; --poster-color: transparent; }

        /* Control UI */
        .ui-overlay { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 200; }
        .info-card { background: var(--glass); padding: 30px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        
        .ar-button { 
            width: 100%; padding: 20px; border: none; border-radius: 15px; 
            background: var(--dark); color: #fff; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }

        /* Diagnostic Panel */
        #diagnostic-log {
            position: absolute; top: 20px; left: 20px; width: 280px; 
            background: rgba(0,0,0,0.8); color: #00ff00; font-family: monospace; 
            font-size: 11px; padding: 15px; border-radius: 10px; z-index: 500;
            pointer-events: none; line-height: 1.5;
        }
        .log-error { color: var(--err); font-weight: bold; }

        /* Fallback Modal */
        #error-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 40px; border-radius: 30px; text-align: center; }
    </style>
</head>
<body>

    <div id="diagnostic-log">SYSTEM IDLE...</div>

    <aside class="sidebar">
        <div class="sidebar-header"><h1>LUXÉ</h1></div>
        <div class="product-list" id="p-list"></div>
    </aside>

    <main class="stage">
        <model-viewer id="engine"
            camera-controls 
            auto-rotate 
            shadow-intensity="1"
            ar 
            ar-modes="webxr scene-viewer quick-look"
            ar-scale="auto"
            crossorigin="anonymous" 
            loading="eager"
            /* This tells iOS to use the USDZ file if provided */
            ios-src=""> 
            <button slot="ar-button" id="hidden-ar-trigger" style="display:none;"></button>
        </model-viewer>

        <div class="ui-overlay">
            <div class="info-card">
                <h2 id="view-name" style="margin:0 0 5px 0; font-weight: 400;">Loading...</h2>
                <div id="view-price" style="color: var(--accent); font-weight: 600; margin-bottom: 20px;">$0.00</div>
                <button class="ar-button" id="ar-trigger">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    VIEW IN YOUR SPACE
                </button>
            </div>
        </div>
    </main>

    <div id="error-modal">
        <div class="modal-box">
            <h3 id="err-title" style="color:var(--err)">AR Blocked</h3>
            <p id="err-msg" style="color:#666; font-size:14px; margin-bottom:25px;"></p>
            <div id="qr-wrap" style="display:none; margin-bottom:20px;">
                <img id="qr-code" style="width:180px; height:180px;">
                <p style="font-size:10px; color:#999;">Scan with mobile to bypass desktop restriction</p>
            </div>
            <button onclick="document.getElementById('error-modal').style.display='none'" style="width:100%; padding:15px; border:none; background:#eee; border-radius:10px;">Close</button>
        </div>
    </div>

<script>
    // 1. CLOUDINARY HANDLER (Professional mapping)
    const CLOUD_NAME = "duhidqjmj";
    
    // Update your resolveAsset function to be even stricter
    function resolveAsset(url, isModel = false) {
        if (!url || url === "None") return "";
        let path = url.replace('/media/', '');
        
        // Ensure we use 'raw' for models to preserve MIME types
        const type = isModel ? 'raw/upload' : 'image/upload';
        
        // If it's already a Cloudinary URL, just ensure it's HTTPS
        if (url.includes('res.cloudinary.com')) {
            return url.replace('http://', 'https://');
        }
        
        return `https://res.cloudinary.com/${CLOUD_NAME}/${type}/${path}`;
    }

    const inventory = [
        {% for p in products %}
        {
            id: "{{ p.id|escapejs }}",
            name: "{{ p.name|escapejs }}",
            price: "{{ p.price|escapejs }}",
            glb: resolveAsset("{% if p.model_3d %}{{ p.model_3d.url|escapejs }}{% endif %}", true),
            // PROFESSIONAL ADDITION: Add a field in Django for USDZ if you want 100% iPhone success
            usdz: resolveAsset("{% if p.usdz_model %}{{ p.usdz_model.url|escapejs }}{% endif %}", true)
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    

    // 3. CORE SYSTEM
    const Engine = {
        viewer: document.getElementById('engine'),
        log: document.getElementById('diagnostic-log'),

        init() {
            this.updateLog("Initializing AR Engine...");
            this.renderList();
            if (inventory.length > 0) this.select(inventory[0].id);
            
            document.getElementById('ar-trigger').addEventListener('click', () => this.launchAR());

            // Listen for load errors
            this.viewer.addEventListener('error', (e) => {
                this.updateLog(`MODEL LOAD ERROR: ${e.detail.type}`, true);
            });

            this.viewer.addEventListener('load', () => {
                this.updateLog("Model successfully loaded into stage.");
            });
        },

        updateLog(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString().split(' ')[0];
            const line = `<div class="${isError ? 'log-error' : ''}">[${timestamp}] ${msg}</div>`;
            this.log.innerHTML = line + this.log.innerHTML;
        },

        select(id) {
            const item = inventory.find(p => p.id == id);
            this.viewer.src = item.glb;
            
            // Set the iOS source specifically
            if(item.usdz) {
                this.viewer.setAttribute('ios-src', item.usdz);
            } else {
                this.viewer.removeAttribute('ios-src');
            }
            document.getElementById('view-name').innerText = item.name;
            document.getElementById('view-price').innerText = `$${item.price}`;
            
            document.querySelectorAll('.product-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-id="${id}"]`).classList.add('active');
        },

        launchAR() {
            this.updateLog("Launching Diagnostics...");
            
            // CHECK 1: HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                return this.showError("Security Restriction", "AR requires an HTTPS connection. Browsers block camera access on insecure sites.");
            }

            // CHECK 2: Browser Capability
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (!isMobile) {
                this.updateLog("Desktop detected. Generating QR.");
                return this.showError("Desktop Mode", "Direct AR is only available on mobile devices. Use the QR code to continue.", true);
            }

            // CHECK 3: Handshake
            if (this.viewer.canActivateAR) {
                this.updateLog("Handshake successful. Opening AR...");
                this.viewer.activateAR();
            } else {
                this.updateLog("Hardware check failed.", true);
                this.showError("Hardware Error", "Your device supports AR, but the 3D model couldn't be initialized for the environment. Ensure 'model/gltf-binary' is set in Cloudinary.");
            }
        },

        showError(title, msg, showQR = false) {
            document.getElementById('err-title').innerText = title;
            document.getElementById('err-msg').innerText = msg;
            const qrWrap = document.getElementById('qr-wrap');
            
            if (showQR) {
                const url = encodeURIComponent(window.location.href);
                document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${url}`;
                qrWrap.style.display = 'block';
            } else {
                qrWrap.style.display = 'none';
            }
            
            document.getElementById('error-modal').style.display = 'flex';
        },

        renderList() {
            const container = document.getElementById('p-list');
            container.innerHTML = inventory.map(p => `
                <div class="product-item" data-id="${p.id}" onclick="Engine.select('${p.id}')">
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="font-size:12px; color:#999;">$${p.price}</div>
                </div>
            `).join('');
        }
    };

    window.onload = () => Engine.init();
</script>
</body>
</html>
